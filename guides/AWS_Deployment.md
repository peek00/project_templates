# AWS Deployment

This guide is meant to document the learning points from deploying a full stack ReactJS + ExpressJS application for my final year project.

The service was deployed on AWS cloud using a combination of **S3, EC2, RDS (PSQL), Route 53**. 

The GitHub action workflow associated with the CI/CD is [here](pr_to_master.yaml). To note are the following
1. Require the use of `scp -o StrictHostKeyChecking=no` when using GitHub runner to copy files over into EC2 instance.
2. `process.CI` is set to false using `CI: false` to treat warnings as warnings and NOT errors.
3. Have to set up symbolic link on EC2 to run `pm2` command from GitHub runner.
4. The `dist` file generated by the `npm run build` command for the server did not contain the neccesary packages needed to run it. I had to copy over the `package.json` file alongside the entire `dist` file, run `npm install` before I was able to run `index.js` inside the `dist` file.

## Deployment Broad Steps
1. Purchase domain name from `AWS Route 53` and set up hosted zone

---
### Issues connecting from EC2 to RDS

I was stuck on trying connect my EC2 instance to my RDS instance for the longest time. It turns out that in the version of PSQL that I used (15.5), AWS made it a default to require a SSL connection when attempting to connect to the RDS. As both EC2 and RDS was actually in the same private subnet, the fix was to create a new parameter group for PSQL 15 and to disable the `rds.force_ssl` parameter by setting it to 1. 

---
### Issues starting up NodeJS application on EC2

Some takeaways I have learnt from this is that if you were to just `export ENV_VAR=VALUE` inside the EC2 shell, it will only persist until you exit the shell. Similar, if you were to do `npm run start` or `node` etc the instance will be terminated when you exit the shell. 

To **allow environment variables to persist** after you have exited the shell, do the following.
```
nano ~/.bashrc
<!-- Add in environment variables using the following format. -->
export ENV_VAR=VALUE
<!-- Save the edited copy. Run the following once to reload environment variables. -->
source ~/.bashrc
<!-- Can verify by using the following -->
env
```

To allow the server to continue running upon shell exit, we will have to use `pm2`. Below are some helpful commands. 
```
npm install pm2@latest -g
pm2 start <file_path.js> --name <app_name>
pm2 list
pm2 stop <app_name>
```
If you are facing `pm2 command not found` error when trying to run `pm2` from a GitHub runner, checkout the following [link](https://stackoverflow.com/questions/69644460/github-actions-pm2-command-not-found). The error is likely because there is no symbolic link between PM2 whatever that means. To fix that, run the following commands once you have SSH into the EC2 instance with PM2 installed.
```
sudo ln -s "$NVM_DIR/versions/node/$(nvm version)/bin/node" "/usr/local/bin/node"
sudo ln -s "$NVM_DIR/versions/node/$(nvm version)/bin/npm" "/usr/local/bin/npm"
sudo ln -s "$NVM_DIR/versions/node/$(nvm version)/bin/pm2" "/usr/local/bin/pm2"
```
